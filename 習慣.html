
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­ç¿’æ…£è¿½è¹¤å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* è¨­ç½®æ·±è‰²èƒŒæ™¯ */
            color: #e2e8f0;
        }
        /* è‡ªå®šç¾©æ²è»¸ï¼Œä»¥æå‡è¡Œå‹•è£ç½®ä¸Šçš„è¦–è¦ºé«”é©— */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
    </style>
    <!-- PWA ç›¸é—œ META æ¨™ç±¤ï¼Œè®“ iOS æ”¯æ´å…¨è¢å¹•æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åŸå­ç¿’æ…£">
    <!-- ä½”ä½åœ–æ¨™ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰æ›¿æ›ç‚ºçœŸå¯¦åœ–ç‰‡ -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=AH">
    <!-- Manifest Link (ç”± JS æ³¨å…¥) -->
    <link rel="manifest" id="manifest-link">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Define global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-atomic-habit-tracker';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global Firebase instances and state
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;
        let currentStep = 0;
        let tempFormData = {}; // åœ¨å¤šæ­¥é©Ÿæµç¨‹ä¸­æš«æ™‚å„²å­˜è³‡æ–™

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ä»¥é€²è¡Œèª¿è©¦
        setLogLevel('Debug');

        // PWA è¨­ç½®å‡½æ•¸ (åƒ…è™•ç† Manifestï¼Œç§»é™¤ Service Worker)
        const setupPWA = () => {
            // 1. åµŒå…¥ Web App Manifest
            const manifest = {
                "name": "åŸå­ç¿’æ…£è¿½è¹¤å™¨",
                "short_name": "åŸå­ç¿’æ…£",
                "description": "è®“å¥½ç¿’æ…£é¡¯è€Œæ˜“è¦‹ã€è¼•è€Œæ˜“èˆ‰ã€æœ‰å¸å¼•åŠ›ã€ä»¤äººæ»¿æ„ã€‚",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#4f46e5",
                "icons": [
                    {
                        "src": "https://placehold.co/192x192/4f46e5/ffffff?text=AH",
                        "sizes": "192x192",
                        "type": "image/png"
                    },
                    {
                        "src": "https://placehold.co/512x512/4f46e5/ffffff?text=AH",
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };
            
            // å°‡ Manifest æ³¨å…¥åˆ° DOM ä¸­
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-link').setAttribute('href', manifestURL);

            // å‚™è¨»ï¼šç”±æ–¼ç’°å¢ƒé™åˆ¶ï¼ŒService Worker è¨»å†Šå·²ç§»é™¤ã€‚
        };
        // PWA è¨­ç½®å‡½æ•¸çµæŸ

        // å®šç¾©å¤šæ­¥é©Ÿè¡¨å–®çš„æ­¥é©Ÿ
        const STEPS = [
            {
                id: 'identity-goal',
                label: 'èº«ä»½ç›®æ¨™ (æ³•å‰‡ 1: è®“å®ƒé¡¯è€Œæ˜“è¦‹)',
                placeholder: 'ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸€ä½è®€è€…',
                subtext: 'ä½ æƒ³æˆç‚ºä»€éº¼æ¨£çš„äººï¼Ÿ (èº«åˆ†èªåŒ/æ–¹å‘)',
                type: 'text',
                required: true,
                nextHint: 'ä¸‹ä¸€æ­¥ï¼šè¨­å®šåŸ·è¡Œæ™‚é–“/åœ°é» (æ³•å‰‡ 1)', // æ³•å‰‡ 1, ç¬¬äºŒéƒ¨åˆ†
            },
            {
                id: 'reminder-time',
                label: 'æé†’æ™‚é–“ (æ³•å‰‡ 1: è®“å®ƒé¡¯è€Œæ˜“è¦‹)',
                placeholder: '19:00',
                subtext: 'ä½•æ™‚ä½•åœ°è¦åšï¼Ÿ (å»ºç«‹åŸ·è¡Œæ„åœ–)',
                type: 'time',
                required: false,
                nextHint: 'ä¸‹ä¸€æ­¥ï¼šè¨­å®šä½ çš„æœ€å°è¡Œå‹• (æ³•å‰‡ 3)', // æ³•å‰‡ 3
            },
            {
                id: 'habit-name',
                label: 'ç¿’æ…£è¡Œç‚º (æ³•å‰‡ 3: è®“å®ƒè¼•è€Œæ˜“èˆ‰)',
                placeholder: 'ä¾‹å¦‚ï¼šé–±è®€ä¸€é æ›¸',
                subtext: 'ä½ çš„æœ€å°å•Ÿå‹•ç¿’æ…£è¡Œç‚ºæ˜¯ä»€éº¼ï¼Ÿ (è¶Šå°è¶Šå¥½ï¼)',
                type: 'text',
                required: true,
                nextHint: 'ä¸‹ä¸€æ­¥ï¼šè¨­å®šç«‹å³çè³ (æ³•å‰‡ 2)', // æ³•å‰‡ 2
            },
            {
                id: 'habit-reward',
                label: 'ç«‹å³çè³ (æ³•å‰‡ 2: è®“å®ƒæœ‰å¸å¼•åŠ›)',
                placeholder: 'ä¾‹å¦‚ï¼šå®Œæˆå¾Œå¯ä»¥çœ‹ä¸€é›† Netflix',
                subtext: 'åšå®Œä¹‹å¾Œçš„ç«‹å³çè³æ˜¯ä»€éº¼ï¼Ÿ (æ­é…çå‹µ)',
                type: 'text',
                required: false,
                nextHint: 'ä¸‹ä¸€æ­¥ï¼šè¨­å®šé•·æœŸç¨±è™Ÿ (æ³•å‰‡ 4)', // æ³•å‰‡ 4
            },
            {
                id: 'streak-title',
                label: 'é‡Œç¨‹ç¢‘ç¨±è™Ÿ (æ³•å‰‡ 4: è®“å®ƒä»¤äººæ»¿æ„)',
                placeholder: 'ä¾‹å¦‚ï¼šè‡ªå¾‹çš„éµäºº / ç¿’æ…£å¤§å¸«',
                subtext: 'é€£çºŒå®Œæˆ 21 å¤©å¾Œæƒ³ç²å¾—çš„ç¨±è™Ÿ/çå‹µæ˜¯ä»€éº¼ï¼Ÿ',
                type: 'text',
                required: false,
                nextHint: 'é»æ“Šæäº¤å®Œæˆç¿’æ…£è¨­å®š',
                isLastStep: true,
            },
        ];

        /**
         * å°‡æ—¥æœŸç‰©ä»¶è½‰æ›ç‚º YYYY-MM-DD æ ¼å¼çš„å­—ä¸²ã€‚
         * @param {Date} date
         * @returns {string}
         */
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        /**
         * è¨ˆç®—ç•¶å‰é€£çºŒå¤©æ•¸å’Œä»Šæ—¥å®Œæˆç‹€æ…‹ã€‚
         * @param {string[]} history Array of YYYY-MM-DD dates.
         * @returns {{streak: number, completedToday: boolean}}
         */
        const calculateStreak = (history) => {
            if (!history || history.length === 0) {
                return { streak: 0, completedToday: false };
            }
            
            // ä½¿ç”¨æ¸…æ™°ã€æ¨™æº–çš„æ–¹å¼è¨ˆç®—é€£çºŒå¤©æ•¸
            const todayStr = formatDate(new Date());
            const isCompletedToday = history.includes(todayStr);

            let currentStreak = 0;
            let d = new Date(); // å¾ä»Šå¤©é–‹å§‹æª¢æŸ¥
            
            // 1. å¦‚æœä»Šå¤©å®Œæˆäº†ï¼Œé€£çºŒå¤©æ•¸å¾ 1 é–‹å§‹ï¼Œç„¶å¾Œæª¢æŸ¥æ˜¨å¤©
            if (isCompletedToday) {
                currentStreak = 1;
                d.setDate(d.getDate() - 1); // æª¢æŸ¥æ˜¨å¤©
            } else {
                // 2. å¦‚æœä»Šå¤©æ²’æœ‰å®Œæˆï¼Œé€£çºŒå¤©æ•¸ç‚º 0
                return { streak: 0, completedToday: isCompletedToday };
            }
            
            // è¿´åœˆå¾€å›æª¢æŸ¥
            for (let i = 0; i < 365; i++) {
                const dateToCheck = formatDate(d);
                if (history.includes(dateToCheck)) {
                    currentStreak++;
                } else {
                    // ç™¼ç¾é–“éš”ï¼Œé€£çºŒå¤©æ•¸ä¸­æ–·
                    break;
                }
                d.setDate(d.getDate() - 1); // å†å¾€å›ä¸€å¤©
            }
            
            return { streak: currentStreak, completedToday: isCompletedToday };
        };


        /**
         * æ¸²æŸ“ Firestore ä¸­çš„ç¿’æ…£æ¸…å–®ã€‚
         * @param {Object[]} habits Array of habit objects.
         */
        const renderHabits = (habits) => {
            const habitList = document.getElementById('habit-list');
            const noHabits = document.getElementById('no-habits');
            habitList.innerHTML = ''; // æ¸…é™¤ç¾æœ‰æ¸…å–®

            if (!habits || habits.length === 0) {
                noHabits.classList.remove('hidden');
                return;
            }
            noHabits.classList.add('hidden');

            habits.forEach(habit => {
                const { streak, completedToday } = calculateStreak(habit.history);
                const buttonColor = completedToday ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700';
                const buttonText = completedToday ? 'ä»Šæ—¥å·²å®Œæˆ âœ…' : 'æ¨™è¨˜å®Œæˆ';
                const streakColor = streak > 0 ? 'text-green-400' : 'text-gray-400';
                
                // é€£çºŒç¨±è™Ÿé‚è¼¯
                const hasAchievedTitle = streak >= 21;
                const streakTitleText = habit.streakTitle || 'æœªè¨­å®šç¨±è™Ÿ';

                const achievementStatus = hasAchievedTitle 
                    ? `<span class="bg-yellow-500 text-gray-900 px-2 py-0.5 rounded-full text-xs font-semibold">ğŸ‰ å·²é”æˆï¼ ${streakTitleText}</span>`
                    : `<span class="text-gray-400 text-sm">ç›®æ¨™ç¨±è™Ÿï¼š${streakTitleText}</span>`;


                const card = `
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col space-y-3 transition duration-300 ease-in-out hover:shadow-2xl">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start">
                            <!-- èº«ä»½èªåŒ (Identity) -->
                            <div class="mb-2 sm:mb-0">
                                <p class="text-sm font-light text-indigo-400">
                                    èº«ä»½ç›®æ¨™:
                                </p>
                                <p class="text-xl font-semibold">${habit.identity}</p>
                            </div>
                            <!-- é€£çºŒå¤©æ•¸ (Streak) -->
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-medium text-gray-400">é€£çºŒ:</span>
                                <span class="text-3xl font-extrabold ${streakColor}">${streak}</span>
                                <span class="text-xl font-extrabold ${streakColor}">å¤©</span>
                            </div>
                        </div>

                        <!-- ç¿’æ…£ (Habit) - æœ€å°å•Ÿå‹•é–€æª» -->
                        <p class="text-lg text-gray-200 border-l-4 pl-3 border-indigo-500/50">
                            ${habit.name}
                        </p>
                        
                        <!-- çè³èˆ‡æé†’é¡¯ç¤º -->
                        <div class="flex flex-col sm:flex-row sm:space-x-8 space-y-2 sm:space-y-0 text-sm text-gray-400 pt-1 border-t border-gray-700/50">
                            <!-- é æœŸçè³ (æ³•å‰‡ 2) -->
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 min-w-4"><path d="M12 2a3 3 0 0 0-3 3v7c0 1.66 1.34 3 3 3s3-1.34 3-3V5a3 3 0 0 0-3-3z"/><path d="M16 12h2l-2 5h-4l-2-5h2"/><path d="M12 18v4"/><path d="M9 21h6"/></svg>
                                <span class="truncate">çè³: ${habit.reward || 'ç„¡'}</span>
                            </div>
                            <!-- æé†’æ™‚é–“ (æ³•å‰‡ 1) -->
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 min-w-4"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <span>æé†’æ™‚é–“: ${habit.reminderTime || 'æœªè¨­å®š'}</span>
                            </div>
                        </div>
                        <!-- çè³èˆ‡æé†’é¡¯ç¤ºçµæŸ -->
                        
                        <!-- 21å¤©ç¨±è™Ÿç›®æ¨™é¡¯ç¤º -->
                        <div class="pt-2 border-t border-gray-700/50 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 min-w-4"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                ${achievementStatus}
                            </div>
                        </div>

                        <div class="pt-2 flex justify-between items-center">
                            <!-- æ¨™è¨˜å®ŒæˆæŒ‰éˆ• (æ³•å‰‡ 4) -->
                            <button data-id="${habit.id}" data-history='${JSON.stringify(habit.history)}'
                                class="toggle-habit-btn ${buttonColor} text-white font-bold py-2 px-4 rounded-full transition duration-150 ease-in-out shadow-md disabled:opacity-50"
                                ${completedToday ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                            <!-- ç§»é™¤æŒ‰éˆ• -->
                            <button data-id="${habit.id}" class="remove-habit-btn text-red-400 hover:text-red-500 text-sm p-2 rounded-full transition duration-150 ease-in-out">
                                ç§»é™¤
                            </button>
                        </div>
                    </div>
                `;
                habitList.insertAdjacentHTML('beforeend', card);
            });

            // é‡æ–°é™„åŠ äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('.toggle-habit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const history = JSON.parse(e.currentTarget.getAttribute('data-history'));
                    toggleHabit(id, history);
                });
            });

            document.querySelectorAll('.remove-habit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    // ä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ confirm æ›¿ä»£æ–¹æ¡ˆ
                    if (!window.confirm("ç¢ºå®šè¦ç§»é™¤é€™å€‹ç¿’æ…£å—ï¼Ÿæ‰€æœ‰é€²åº¦å°‡æœƒéºå¤±ã€‚")) {
                         return;
                    }
                    removeHabit(id);
                });
            });
        };

        /**
         * è¨­ç½®ç¿’æ…£çš„å¯¦æ™‚ç›£è½å™¨ã€‚
         */
        const loadHabits = () => {
            if (!db || !userId) {
                console.error("Firestore æˆ–ä½¿ç”¨è€… ID å°šæœªåˆå§‹åŒ–ã€‚");
                return;
            }

            // è·¯å¾‘: /artifacts/{appId}/users/{userId}/habits
            const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
            
            // ç›£è½å¯¦æ™‚è®ŠåŒ–
            onSnapshot(habitsCollectionRef, (snapshot) => {
                const habits = [];
                snapshot.forEach(doc => {
                    habits.push({ id: doc.id, ...doc.data(), history: doc.data().history || [] });
                });
                renderHabits(habits);
            }, (error) => {
                console.error("ç›£è½ç¿’æ…£é›†åˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                document.getElementById('feedback').textContent = "è¼‰å…¥ç¿’æ…£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
            });
        };

        /**
         * æ–°å¢ä¸€å€‹ç¿’æ…£ã€‚
         * @param {string} name - æœ€å°ã€å®¹æ˜“çš„ç¿’æ…£åç¨±ã€‚
         * @param {string} identity - èº«ä»½ç›®æ¨™ã€‚
         * @param {string} reward - é æœŸçš„çè³ã€‚
         * @param {string} reminderTime - é¦–é¸æ™‚é–“ (HH:MM)ã€‚
         * @param {string} streakTitle - 21 å¤©é€£çºŒç¨±è™Ÿã€‚
         */
        const addHabit = async (name, identity, reward, reminderTime, streakTitle) => {
            if (!db || !userId) return;

            const newHabit = {
                name: name || 'æœªå‘½åç¿’æ…£',
                identity: identity || 'æœªè¨­å®šèº«ä»½ç›®æ¨™',
                reward: reward || 'ç„¡', 
                reminderTime: reminderTime || 'æœªè¨­å®š',
                streakTitle: streakTitle || 'ç¿’æ…£æ–°äºº',
                history: [], // Array of YYYY-MM-DD dates completed
                createdAt: new Date(),
            };

            try {
                const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
                await addDoc(habitsCollectionRef, newHabit);
                document.getElementById('feedback').textContent = "âœ… ç¿’æ…£å·²æˆåŠŸå»ºç«‹ï¼";
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ æ–°å¢ç¿’æ…£å¤±æ•—ã€‚";
            }
        };

        /**
         * åˆ‡æ›ç¿’æ…£ä»Šå¤©çš„å®Œæˆç‹€æ…‹ã€‚
         * @param {string} habitId 
         * @param {string[]} currentHistory 
         */
        const toggleHabit = async (habitId, currentHistory) => {
            if (!db || !userId) return;
            
            const todayStr = formatDate(new Date());
            const habitDocRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId);
            
            // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²å®Œæˆ
            const isCompleted = currentHistory.includes(todayStr);

            let newHistory;
            let feedbackMsg;
            
            if (!isCompleted) {
                // æ¨™è¨˜ç‚ºå®Œæˆ (æ–°å¢åˆ°æ­·å²è¨˜éŒ„)
                newHistory = [...currentHistory, todayStr];
                feedbackMsg = "ğŸ‰ æ­å–œï¼ä»Šå¤©å·²å®Œæˆï¼";
            } else {
                // ä¸æ‡‰ç™¼ç”Ÿï¼Œå› ç‚ºæŒ‰éˆ•æœƒè¢«ç¦ç”¨ï¼Œä½†ç‚ºäº†å®‰å…¨ï¼šå¾æ­·å²è¨˜éŒ„ä¸­ç§»é™¤ (å–æ¶ˆå®Œæˆ)
                newHistory = currentHistory.filter(date => date !== todayStr);
                feedbackMsg = "å·²å–æ¶ˆä»Šå¤©çš„å®Œæˆç‹€æ…‹ã€‚";
            }

            try {
                // ä½¿ç”¨ updateDoc
                await updateDoc(habitDocRef, {
                    history: newHistory.sort() // ä¿æŒæ­·å²è¨˜éŒ„æ’åºä»¥ä¾¿æ–¼é€£çºŒè¨ˆç®—
                });

                // é¡¯ç¤ºæˆåŠŸå›é¥‹
                document.getElementById('feedback').textContent = feedbackMsg;
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
                
            } catch (e) {
                console.error("æ›´æ–°æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚";
            }
        };

        /**
         * ç§»é™¤ä¸€å€‹ç¿’æ…£ã€‚
         * @param {string} habitId 
         */
        const removeHabit = async (habitId) => {
             if (!db || !userId) return;
             
             try {
                const habitDocRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId);
                await deleteDoc(habitDocRef); // æ°¸ä¹…åˆªé™¤
                document.getElementById('feedback').textContent = "ğŸ—‘ï¸ ç¿’æ…£å·²ç§»é™¤ã€‚";
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
            } catch (e) {
                console.error("ç§»é™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ ç§»é™¤ç¿’æ…£å¤±æ•—ã€‚";
            }
        };


        /**
         * æ¸²æŸ“ç•¶å‰æ­¥é©Ÿçš„å…§å®¹ã€‚
         * @param {number} stepIndex
         */
        const renderStep = (stepIndex) => {
            const stepContent = document.getElementById('step-content');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressIndicator = document.getElementById('progress-indicator');
            const feedbackElement = document.getElementById('feedback-hint');
            const step = STEPS[stepIndex];

            if (!step) return;

            // --- 1. æ¸²æŸ“å…§å®¹ ---
            // ç‚ºæ™‚é–“è¼¸å…¥è¨­ç½®é è¨­å€¼ï¼Œå¦å‰‡ä½¿ç”¨å„²å­˜çš„è³‡æ–™
            const initialValue = step.type === 'time' && !tempFormData[step.id] ? '19:00' : tempFormData[step.id] || '';

            let inputHtml;
            if (step.type === 'time') {
                inputHtml = `
                    <input type="time" id="${step.id}" value="${initialValue}" step="300"
                           class="w-full px-4 py-3 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500">
                `;
            } else {
                inputHtml = `
                    <input type="text" id="${step.id}" placeholder="${step.placeholder}" value="${initialValue}" ${step.required ? 'required' : ''}
                           class="w-full px-4 py-3 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500">
                `;
            }
            
            stepContent.innerHTML = `
                <div class="animate-in fade-in slide-in-from-right-1 duration-300">
                    <label for="${step.id}" class="block text-sm font-medium text-gray-300 mb-1">${step.label}</label>
                    ${inputHtml}
                    <p class="text-xs text-gray-400 mt-1">${step.subtext}</p>
                </div>
            `;
            
            // è¨­ç½®ç„¦é»åˆ°è¼¸å…¥æ¬„ä½
            document.getElementById(step.id)?.focus();


            // --- 2. æ¸²æŸ“é€²åº¦æŒ‡ç¤ºå™¨ ---
            progressIndicator.innerHTML = STEPS.map((s, index) => `
                <div class="w-3 h-3 rounded-full transition-colors duration-300 ${index === stepIndex ? 'bg-indigo-500' : 'bg-gray-500'}"></div>
            `).join('');

            // --- 3. æ›´æ–°å°èˆªæŒ‰éˆ•å’Œæç¤º ---
            prevBtn.disabled = stepIndex === 0;
            
            nextBtn.textContent = step.isLastStep ? 'æäº¤ä¸¦é–‹å§‹è¿½è¹¤' : 'ä¸‹ä¸€æ­¥';
            nextBtn.classList.toggle('bg-indigo-600', !step.isLastStep);
            nextBtn.classList.toggle('hover:bg-indigo-700', !step.isLastStep);
            nextBtn.classList.toggle('bg-green-600', step.isLastStep);
            nextBtn.classList.toggle('hover:bg-green-700', step.isLastStep);

            feedbackElement.textContent = step.nextHint;
        };

        /**
         * è™•ç†é©—è­‰ã€å„²å­˜è³‡æ–™ä¸¦å‰é€²åˆ°ä¸‹ä¸€æ­¥ã€‚
         */
        const handleNext = () => {
            const currentStepData = STEPS[currentStep];
            const inputElement = document.getElementById(currentStepData.id);
            const feedbackElement = document.getElementById('feedback');
            
            // é©—è­‰
            if (currentStepData.required && (!inputElement || !inputElement.value.trim())) {
                feedbackElement.textContent = `âš ï¸ è«‹è¼¸å…¥ ${currentStepData.label.split('(')[0].trim()}ã€‚`;
                setTimeout(() => feedbackElement.textContent = '', 3000);
                return;
            }
            
            // å„²å­˜å€¼
            tempFormData[currentStepData.id] = inputElement ? inputElement.value.trim() : '';

            if (currentStepData.isLastStep) {
                // æœ€å¾Œä¸€æ­¥ï¼šæäº¤ç¿’æ…£
                const name = tempFormData['habit-name'];
                const identity = tempFormData['identity-goal'];
                const reward = tempFormData['habit-reward'];
                const reminderTime = tempFormData['reminder-time'];
                const streakTitle = tempFormData['streak-title'];
                
                // æœ€çµ‚æäº¤é‚è¼¯
                addHabit(name, identity, reward, reminderTime, streakTitle);

                // æäº¤æˆåŠŸå¾Œé‡è¨­ç‹€æ…‹ä¸¦é—œé–‰è¡¨å–®
                currentStep = 0;
                tempFormData = {};
                toggleNewHabitForm(false);
                return;

            } else {
                // ç§»å‹•åˆ°ä¸‹ä¸€æ­¥
                currentStep++;
                renderStep(currentStep);
            }
        };

        /**
         * è™•ç†ç§»å‹•åˆ°ä¸Šä¸€æ­¥ã€‚
         */
        const handlePrevious = () => {
            if (currentStep > 0) {
                currentStep--;
                renderStep(currentStep);
            }
        };

        /**
         * åˆ‡æ›æ–°å¢ç¿’æ…£è¡¨å–®çš„å¯è¦‹æ€§ã€‚
         * @param {boolean} [force=undefined] - å¼·åˆ¶ç‹€æ…‹ (true ç‚ºé¡¯ç¤º, false ç‚ºéš±è—)ã€‚
         */
        const toggleNewHabitForm = (force) => {
            const formContainer = document.getElementById('new-habit-form-container');
            const button = document.getElementById('toggle-form-btn');
            
            const isHidden = formContainer.classList.contains('max-h-0');
            let newState = force !== undefined ? force : isHidden;

            if (newState) {
                formContainer.classList.remove('max-h-0', 'invisible', 'opacity-0');
                formContainer.classList.add('max-h-96', 'opacity-100');
                button.textContent = 'å–æ¶ˆå»ºç«‹';
                button.classList.remove('bg-green-600');
                button.classList.add('bg-gray-600');
                
                // æ‰“é–‹è¡¨å–®æ™‚é‡è¨­ä¸¦æ¸²æŸ“ç¬¬ 0 æ­¥
                currentStep = 0;
                tempFormData = {};
                renderStep(currentStep);

            } else {
                formContainer.classList.remove('max-h-96', 'opacity-100');
                formContainer.classList.add('max-h-0', 'invisible', 'opacity-0');
                button.textContent = 'â• å»ºç«‹æ–°ç¿’æ…£';
                button.classList.remove('bg-gray-600');
                button.classList.add('bg-green-600');
            }
        };


        /**
         * ä¸»è¦åˆå§‹åŒ–å‡½æ•¸ã€‚
         */
        const initFirebaseAndApp = () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase é…ç½®éºå¤±ã€‚ç„¡æ³•åˆå§‹åŒ– Firebaseã€‚");
                document.getElementById('app-status').textContent = "âš ï¸ éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: åˆå§‹åŒ–ä¸­...";
                
                // 1. èªè­‰ (è‡ªå®šç¾© Token æˆ–åŒ¿å)
                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("èªè­‰å¤±æ•—:", error);
                        document.getElementById('app-status').textContent = `âŒ èªè­‰å¤±æ•—: ${error.code}`;
                        try {
                             await signInAnonymously(auth);
                        } catch(anonError) {
                            console.error("åŒ¿åç™»å…¥ä¹Ÿå¤±æ•—äº†:", anonError);
                        }
                    }
                };

                // 2. èªè­‰ç‹€æ…‹ç›£è½å™¨ (åœ¨è¼‰å…¥è³‡æ–™å‰ç²å– userId è‡³é—œé‡è¦)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: é€£ç·šæˆåŠŸ";
                        document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
                        loadHabits(); // èªè­‰å¾Œé–‹å§‹ç›£è½è³‡æ–™è®ŠåŒ–
                    } else {
                        if (userId === null) {
                            document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: ç™»å…¥ä¸­...";
                        }
                    }
                });
                
                // é–‹å§‹èªè­‰æµç¨‹
                authenticate();

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                document.getElementById('app-status').textContent = `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`;
            }

        };

        window.onload = () => {
            setupPWA(); // åˆå§‹åŒ– PWA Manifest
            initFirebaseAndApp();
            
            // --- å¤šæ­¥é©Ÿè¡¨å–®è™•ç† ---
            document.getElementById('new-habit-form').addEventListener('submit', (e) => e.preventDefault()); // é˜²æ­¢é è¨­æäº¤è¡Œç‚º
            document.getElementById('toggle-form-btn').addEventListener('click', () => toggleNewHabitForm());
            
            // é™„åŠ ä¸‹ä¸€æ­¥/ä¸Šä¸€æ­¥ç›£è½å™¨
            document.getElementById('next-btn').addEventListener('click', handleNext);
            document.getElementById('prev-btn').addEventListener('click', handlePrevious);
            
            // æ‡‰ç”¨ç¨‹å¼è¼‰å…¥æ™‚åˆå§‹åŒ–è¡¨å–®è¦–åœ– (åˆå§‹ç‚ºéš±è—)
            renderStep(currentStep); 
        };

    </script>
</head>
<body class="min-h-screen p-4 sm:p-6 pb-20">
    <div class="max-w-xl mx-auto">
        <header class="text-center mb-6 pt-4">
            <h1 class="text-3xl font-extrabold text-white mb-1">åŸå­ç¿’æ…£è¿½è¹¤å™¨</h1>
            <p class="text-indigo-400 text-sm">è®“å¥½ç¿’æ…£è®Šå¾—é¡¯è€Œæ˜“è¦‹ã€æœ‰å¸å¼•åŠ›ã€è¼•è€Œæ˜“èˆ‰ã€ä»¤äººæ»¿æ„ã€‚</p>
        </header>

        <!-- å»ºç«‹æ–°ç¿’æ…£å€åŸŸ -->
        <div class="mb-6">
            <button id="toggle-form-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg">
                â• å»ºç«‹æ–°ç¿’æ…£
            </button>

            <!-- æ–°ç¿’æ…£è¡¨å–® (ä½¿ç”¨éæ¸¡æ•ˆæœ) -->
            <div id="new-habit-form-container" class="mt-4 overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0 invisible">
                <form id="new-habit-form" class="bg-gray-700 p-4 rounded-xl shadow-inner space-y-4">
                    
                    <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
                    <div id="progress-indicator" class="flex justify-center space-x-2 pb-4 pt-1"></div>
                    
                    <!-- å‹•æ…‹æ­¥é©Ÿå…§å®¹ -->
                    <div id="step-content">
                        <!-- å…§å®¹å°‡ç”± JavaScript æ³¨å…¥ -->
                    </div>
                    
                    <!-- å°èˆªèˆ‡æç¤º -->
                    <div class="pt-4 border-t border-gray-600">
                        <!-- ä¸‹ä¸€æ­¥æç¤º -->
                        <p id="feedback-hint" class="text-center text-sm font-medium text-indigo-300 mb-3"></p>
                        
                        <div class="flex justify-between">
                            <button type="button" id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 disabled:opacity-30">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button type="button" id="next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300">
                                ä¸‹ä¸€æ­¥
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <!-- ç¿’æ…£åˆ—è¡¨ -->
        <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">æˆ‘çš„ç¿’æ…£æ¸…å–®</h2>
        <div id="habit-list" class="space-y-4">
            <!-- ç¿’æ…£å¡ç‰‡å°‡åœ¨æ­¤è™•ç”± JavaScript æ¸²æŸ“ -->
        </div>

        <!-- ç„¡ç¿’æ…£æç¤º -->
        <div id="no-habits" class="text-center p-8 bg-gray-800 rounded-xl shadow-lg mt-6 hidden">
            <p class="text-gray-400 mb-3">ä½ é‚„æ²’æœ‰å»ºç«‹ä»»ä½•ç¿’æ…£ï¼</p>
            <p class="text-white font-medium">é»æ“Šä¸Šæ–¹çš„ã€Œâ• å»ºç«‹æ–°ç¿’æ…£ã€ä¾†é–‹å§‹ä½ çš„æ”¹è®Šå§ã€‚</p>
        </div>

        <!-- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹å’Œå›é¥‹ -->
        <div class="fixed bottom-0 left-0 right-0 bg-gray-900/90 backdrop-blur-sm p-3 border-t border-indigo-700">
            <!-- å…¨åŸŸå›é¥‹å€åŸŸ -->
            <p id="feedback" class="text-center h-5 text-sm font-medium text-yellow-400 mb-1"></p>
            <p id="app-status" class="text-xs text-gray-500 text-center">æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: è¼‰å…¥ä¸­...</p>
            <p id="user-id-display" class="text-xs text-gray-500 text-center mt-1 break-all"></p>
        </div>
    </div>
</body>
</html>