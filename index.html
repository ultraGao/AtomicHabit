<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä¸ç•¶é(å‹•)å…’å•¦~</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* è¨­ç½®æ·±è‰²èƒŒæ™¯ */
            color: #e2e8f0;
        }
        /* è‡ªå®šç¾©æ²è»¸ï¼Œä»¥æå‡è¡Œå‹•è£ç½®ä¸Šçš„è¦–è¦ºé«”é©— */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
    </style>
    <!-- PWA ç›¸é—œ META æ¨™ç±¤ï¼Œè®“ iOS æ”¯æ´å…¨è¢å¹•æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="åŸå­ç¿’æ…£">
    <!-- ä½”ä½åœ–æ¨™ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰æ›¿æ›ç‚ºçœŸå¯¦åœ–ç‰‡ -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=AH">
    <!-- Manifest Link (ç”± JS æ³¨å…¥) -->
    <link rel="manifest" id="manifest-link">
</head>
<body class="min-h-screen p-4 sm:p-6 pb-20">
    <div class="max-w-xl mx-auto">
        <header class="mb-6 pt-4 relative"> 
            <div id="auth-ui-container" class="absolute top-4 right-0 z-10">
                <!-- å¸³è™Ÿç™»å…¥/é€£çµ/ç™»å‡ºæŒ‰éˆ•å°‡ç”± JavaScript æ¸²æŸ“ -->
            </div>
            <h1 class="text-3xl font-extrabold text-white mb-1 text-center">åŸå­ç¿’æ…£è¿½è¹¤å™¨</h1>
            <p class="text-indigo-400 text-sm text-center">è®“å¥½ç¿’æ…£è®Šå¾—é¡¯è€Œæ˜“è¦‹ã€æœ‰å¸å¼•åŠ›ã€è¼•è€Œæ˜“èˆ‰ã€ä»¤äººæ»¿æ„ã€‚</p>
        </header>

        <!-- å»ºç«‹æ–°ç¿’æ…£å€åŸŸ -->
        <div class="mb-6">
            <button id="toggle-form-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg">
                â• å»ºç«‹æ–°ç¿’æ…£
            </button>

            <!-- æ–°ç¿’æ…£è¡¨å–® (ä½¿ç”¨éæ¸¡æ•ˆæœ) -->
            <div id="new-habit-form-container" class="mt-4 overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0 invisible">
                <form id="new-habit-form" class="bg-gray-700 p-4 rounded-xl shadow-inner space-y-4">
                    
                    <!-- é€²åº¦æŒ‡ç¤ºå™¨ -->
                    <div id="progress-indicator" class="flex justify-center space-x-2 pb-4 pt-1"></div>
                    
                    <!-- å‹•æ…‹æ­¥é©Ÿå…§å®¹ -->
                    <div id="step-content">
                        <!-- å…§å®¹å°‡ç”± JavaScript æ³¨å…¥ -->
                    </div>
                    
                    <!-- å°èˆªèˆ‡æç¤º -->
                    <div class="pt-4 border-t border-gray-600">
                        <!-- ä¸‹ä¸€æ­¥æç¤º -->
                        <p id="feedback-hint" class="text-center text-sm font-medium text-indigo-300 mb-3"></p>
                        
                        <div class="flex justify-between">
                            <button type="button" id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 disabled:opacity-30">
                                ä¸Šä¸€æ­¥
                            </button>
                            <button type="button" id="next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition duration-300">
                                ä¸‹ä¸€æ­¥
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <!-- ç¿’æ…£åˆ—è¡¨ -->
        <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">æˆ‘çš„ç¿’æ…£æ¸…å–®</h2>
        <div id="habit-list" class="space-y-4">
            <!-- ç¿’æ…£å¡ç‰‡å°‡åœ¨æ­¤è™•ç”± JavaScript æ¸²æŸ“ -->
        </div>

        <!-- ç„¡ç¿’æ…£æç¤º -->
        <div id="no-habits" class="text-center p-8 bg-gray-800 rounded-xl shadow-lg mt-6 hidden">
            <p class="text-gray-400 mb-3">ä½ é‚„æ²’æœ‰å»ºç«‹ä»»ä½•ç¿’æ…£ï¼</p>
            <p class="text-white font-medium">é»æ“Šä¸Šæ–¹çš„ã€Œâ• å»ºç«‹æ–°ç¿’æ…£ã€ä¾†é–‹å§‹ä½ çš„æ”¹è®Šå§ã€‚</p>
        </div>

        <!-- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹å’Œå›é¥‹ -->
        <div class="fixed bottom-0 left-0 right-0 bg-gray-900/90 backdrop-blur-sm p-3 border-t border-indigo-700">
            <!-- å…¨åŸŸå›é¥‹å€åŸŸ -->
            <p id="feedback" class="text-center h-5 text-sm font-medium text-yellow-400 mb-1"></p>
            <p id="app-status" class="text-xs text-gray-500 text-center">æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: è¼‰å…¥ä¸­...</p>
            <p id="user-id-display" class="text-xs text-gray-500 text-center mt-1 break-all"></p>
        </div>
    </div>

    <!-- Firebase SDKs (v9 æˆ–æ›´é«˜ç‰ˆæœ¬æ¨¡çµ„åŒ–å¯«æ³•) -->
    <!-- ***** ä¿®æ­£ï¼šå°‡æ­¤ script å€å¡Šç§»å‹•åˆ° <body> çš„æœ€åº•éƒ¨ ***** -->
    <script type="module">
        // --- 1. å°å…¥æ‰€æœ‰æ¨è–¦çš„ Firebase æ¨¡çµ„ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, linkWithPopup, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js"; 
        import { getMessaging } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js"; 

        // --- 2. ä½ çš„ Firebase è¨­å®šè³‡è¨Š (ç›´æ¥ä½¿ç”¨ï¼Œç¢ºä¿ä¸æœƒè¢«ç©ºç‰©ä»¶è¦†è“‹) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAa2PYFB90eMMXF4jlZRgvpqZr3Eof916U", // è«‹ç¢ºèªé€™æ˜¯ä½ è‡ªå·±çš„ï¼
            authDomain: "habitkeeper-87e88.firebaseapp.com",
            projectId: "habitkeeper-87e88",
            storageBucket: "habitkeeper-87e88.firebasestorage.app",
            messagingSenderId: "773693972402",
            appId: "1:773693972402:web:23ae51483f3e1a4926ceab",
            measurementId: "G-5X5WNFN4X6"
        };

        // ç‚ºä½ çš„ Firestore è·¯å¾‘å®šç¾© appId
        const appId = firebaseConfig.appId; 

        const initialAuthToken = null; 

        // --- 3. å…¨åŸŸ Firebase å¯¦ä¾‹èˆ‡ç‹€æ…‹ ---
        let app = null;
        let db = null;
        let auth = null;
        let analytics = null; 
        let messaging = null; 
        let userId = null;
        let isAuthReady = false;
        let currentStep = 0;
        let tempFormData = {};

        const googleProvider = new GoogleAuthProvider();

        setLogLevel('Debug');

        const setupPWA = () => {
            const manifest = {
                "name": "åŸå­ç¿’æ…£è¿½è¹¤å™¨",
                "short_name": "åŸå­ç¿’æ…£",
                "description": "è®“å¥½ç¿’æ…£é¡¯è€Œæ˜“è¦‹ã€è¼•è€Œæ˜“èˆ‰ã€æœ‰å¸å¼•åŠ›ã€ä»¤äººæ»¿æ„ã€‚",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#4f46e5",
                "icons": [
                    { "src": "https://placehold.co/192x192/4f46e5/ffffff?text=AH", "sizes": "192x192", "type": "image/png" },
                    { "src": "https://placehold.co/512x512/4f46e5/ffffff?text=AH", "sizes": "512x512", "type": "image/png" }
                ]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-link').setAttribute('href', manifestURL);
        };

        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const calculateStreak = (history) => {
            if (!history || history.length === 0) { return { streak: 0, completedToday: false }; }
            const todayStr = formatDate(new Date());
            const isCompletedToday = history.includes(todayStr);
            let currentStreak = 0;
            let d = new Date();
            if (isCompletedToday) {
                currentStreak = 1;
                d.setDate(d.getDate() - 1);
            } else { return { streak: 0, completedToday: isCompletedToday }; }
            for (let i = 0; i < 365; i++) {
                const dateToCheck = formatDate(d);
                if (history.includes(dateToCheck)) { currentStreak++; } else { break; }
                d.setDate(d.getDate() - 1);
            }
            return { streak: currentStreak, completedToday: isCompletedToday };
        };

        const renderHabits = (habits) => {
            const habitList = document.getElementById('habit-list');
            const noHabits = document.getElementById('no-habits');
            habitList.innerHTML = ''; 

            if (!habits || habits.length === 0) { noHabits.classList.remove('hidden'); return; }
            noHabits.classList.add('hidden');

            habits.forEach(habit => {
                const { streak, completedToday } = calculateStreak(habit.history);
                const buttonColor = completedToday ? 'bg-green-600 hover:bg-green-700' : 'bg-indigo-600 hover:bg-indigo-700';
                const buttonText = completedToday ? 'ä»Šæ—¥å·²å®Œæˆ âœ…' : 'æ¨™è¨˜å®Œæˆ';
                const streakColor = streak > 0 ? 'text-green-400' : 'text-gray-400';
                const hasAchievedTitle = streak >= 21;
                const streakTitleText = habit.streakTitle || 'æœªè¨­å®šç¨±è™Ÿ';

                const achievementStatus = hasAchievedTitle 
                    ? `<span class="bg-yellow-500 text-gray-900 px-2 py-0.5 rounded-full text-xs font-semibold">ğŸ‰ å·²é”æˆï¼ ${streakTitleText}</span>`
                    : `<span class="text-gray-400 text-sm">ç›®æ¨™ç¨±è™Ÿï¼š${streakTitleText}</span>`;

                const card = `
                    <div class="bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col space-y-3 transition duration-300 ease-in-out hover:shadow-2xl">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start">
                            <div class="mb-2 sm:mb-0">
                                <p class="text-sm font-light text-indigo-400">èº«ä»½ç›®æ¨™:</p>
                                <p class="text-xl font-semibold">${habit.identity}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-medium text-gray-400">é€£çºŒ:</span>
                                <span class="text-3xl font-extrabold ${streakColor}">${streak}</span>
                                <span class="text-xl font-extrabold ${streakColor}">å¤©</span>
                            </div>
                        </div>
                        <p class="text-lg text-gray-200 border-l-4 pl-3 border-indigo-500/50">${habit.name}</p>
                        <div class="flex flex-col sm:flex-row sm:space-x-8 space-y-2 sm:space-y-0 text-sm text-gray-400 pt-1 border-t border-gray-700/50">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 min-w-4"><path d="M12 2a3 3 0 0 0-3 3v7c0 1.66 1.34 3 3 3s3-1.34 3-3V5a3 3 0 0 0-3-3z"/><path d="M16 12h2l-2 5h-4l-2-5h2"/><path d="M12 18v4"/><path d="M9 21h6"/></svg>
                                <span class="truncate">çè³: ${habit.reward || 'ç„¡'}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400 min-w-4"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <span>æé†’æ™‚é–“: ${habit.reminderTime || 'æœªè¨­å®š'}</span>
                            </div>
                        </div>
                        <div class="pt-2 border-t border-gray-700/50 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500 min-w-4"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                ${achievementStatus}
                            </div>
                        </div>
                        <div class="pt-2 flex justify-between items-center">
                            <button data-id="${habit.id}" data-history='${JSON.stringify(habit.history)}'
                                class="toggle-habit-btn ${buttonColor} text-white font-bold py-2 px-4 rounded-full transition duration-150 ease-in-out shadow-md disabled:opacity-50"
                                ${completedToday ? 'disabled' : ''}>${buttonText}</button>
                            <button data-id="${habit.id}" class="remove-habit-btn text-red-400 hover:text-red-500 text-sm p-2 rounded-full transition duration-150 ease-in-out">ç§»é™¤</button>
                        </div>
                    </div>
                `;
                habitList.insertAdjacentHTML('beforeend', card);
            });
            document.querySelectorAll('.toggle-habit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const history = JSON.parse(e.currentTarget.getAttribute('data-history'));
                    toggleHabit(id, history);
                });
            });
            document.querySelectorAll('.remove-habit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (!window.confirm("ç¢ºå®šè¦ç§»é™¤é€™å€‹ç¿’æ…£å—ï¼Ÿæ‰€æœ‰é€²åº¦å°‡æœƒéºå¤±ã€‚")) { return; }
                    removeHabit(id);
                });
            });
        };

        const loadHabits = () => {
            if (!db || !userId) { console.error("Firestore æˆ–ä½¿ç”¨è€… ID å°šæœªåˆå§‹åŒ–ã€‚"); return; }
            const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
            onSnapshot(habitsCollectionRef, (snapshot) => {
                const habits = [];
                snapshot.forEach(doc => { habits.push({ id: doc.id, ...doc.data(), history: doc.data().history || [] }); });
                renderHabits(habits);
            }, (error) => {
                console.error("ç›£è½ç¿’æ…£é›†åˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                document.getElementById('feedback').textContent = "è¼‰å…¥ç¿’æ…£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
            });
        };

        const addHabit = async (name, identity, reward, reminderTime, streakTitle) => {
            if (!db || !userId) return;
            const newHabit = {
                name: name || 'æœªå‘½åç¿’æ…£', identity: identity || 'æœªè¨­å®šèº«ä»½ç›®æ¨™', reward: reward || 'ç„¡', 
                reminderTime: reminderTime || 'æœªè¨­å®š', streakTitle: streakTitle || 'ç¿’æ…£æ–°äºº',
                history: [], createdAt: new Date(),
            };
            try {
                const habitsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/habits`);
                await addDoc(habitsCollectionRef, newHabit);
                document.getElementById('feedback').textContent = "âœ… ç¿’æ…£å·²æˆåŠŸå»ºç«‹ï¼";
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
            } catch (e) {
                console.error("æ–°å¢æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ æ–°å¢ç¿’æ…£å¤±æ•—ã€‚";
            }
        };

        const toggleHabit = async (habitId, currentHistory) => {
            if (!db || !userId) return;
            const todayStr = formatDate(new Date());
            const habitDocRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId);
            const isCompleted = currentHistory.includes(todayStr);
            let newHistory;
            let feedbackMsg;
            if (!isCompleted) {
                newHistory = [...currentHistory, todayStr];
                feedbackMsg = "ğŸ‰ æ­å–œï¼ä»Šå¤©å·²å®Œæˆï¼";
            } else {
                newHistory = currentHistory.filter(date => date !== todayStr);
                feedbackMsg = "å·²å–æ¶ˆä»Šå¤©çš„å®Œæˆç‹€æ…‹ã€‚";
            }
            try {
                await updateDoc(habitDocRef, { history: newHistory.sort() });
                document.getElementById('feedback').textContent = feedbackMsg;
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
            } catch (e) {
                console.error("æ›´æ–°æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ æ›´æ–°ç‹€æ…‹å¤±æ•—ã€‚";
            }
        };

        const removeHabit = async (habitId) => {
             if (!db || !userId) return;
             try {
                const habitDocRef = doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId);
                await deleteDoc(habitDocRef);
                document.getElementById('feedback').textContent = "ğŸ—‘ï¸ ç¿’æ…£å·²ç§»é™¤ã€‚";
                setTimeout(() => document.getElementById('feedback').textContent = '', 3000);
            } catch (e) {
                console.error("ç§»é™¤æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ", e);
                document.getElementById('feedback').textContent = "âš ï¸ ç§»é™¤ç¿’æ…£å¤±æ•—ã€‚";
            }
        };

        const renderStep = (stepIndex) => {
            const stepContent = document.getElementById('step-content');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressIndicator = document.getElementById('progress-indicator');
            const feedbackElement = document.getElementById('feedback-hint');
            const step = STEPS[stepIndex];

            if (!step) return;

            const initialValue = step.type === 'time' && !tempFormData[step.id] ? '19:00' : tempFormData[step.id] || '';
            let inputHtml;
            if (step.type === 'time') {
                inputHtml = `<input type="time" id="${step.id}" value="${initialValue}" step="300" class="w-full px-4 py-3 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500">`;
            } else {
                inputHtml = `<input type="text" id="${step.id}" placeholder="${step.placeholder}" value="${initialValue}" ${step.required ? 'required' : ''} class="w-full px-4 py-3 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-indigo-500 focus:border-indigo-500">`;
            }
            
            stepContent.innerHTML = `
                <div class="animate-in fade-in slide-in-from-right-1 duration-300">
                    <label for="${step.id}" class="block text-sm font-medium text-gray-300 mb-1">${step.label}</label>
                    ${inputHtml}
                    <p class="text-xs text-gray-400 mt-1">${step.subtext}</p>
                </div>
            `;
            document.getElementById(step.id)?.focus();
            progressIndicator.innerHTML = STEPS.map((s, index) => `
                <div class="w-3 h-3 rounded-full transition-colors duration-300 ${index === stepIndex ? 'bg-indigo-500' : 'bg-gray-500'}"></div>
            `).join('');

            prevBtn.disabled = stepIndex === 0;
            nextBtn.textContent = step.isLastStep ? 'æäº¤ä¸¦é–‹å§‹è¿½è¹¤' : 'ä¸‹ä¸€æ­¥';
            nextBtn.classList.toggle('bg-indigo-600', !step.isLastStep);
            nextBtn.classList.toggle('hover:bg-indigo-700', !step.isLastStep);
            nextBtn.classList.toggle('bg-green-600', step.isLastStep);
            nextBtn.classList.toggle('hover:bg-green-700', step.isLastStep);
            feedbackElement.textContent = step.nextHint;
        };

        const handleNext = () => {
            const currentStepData = STEPS[currentStep];
            const inputElement = document.getElementById(currentStepData.id);
            const feedbackElement = document.getElementById('feedback');
            
            if (currentStepData.required && (!inputElement || !inputElement.value.trim())) {
                feedbackElement.textContent = `âš ï¸ è«‹è¼¸å…¥ ${currentStepData.label.split('(')[0].trim()}ã€‚`;
                setTimeout(() => feedbackElement.textContent = '', 3000);
                return;
            }
            tempFormData[currentStepData.id] = inputElement ? inputElement.value.trim() : '';

            if (currentStepData.isLastStep) {
                const name = tempFormData['habit-name'];
                const identity = tempFormData['identity-goal'];
                const reward = tempFormData['habit-reward'];
                const reminderTime = tempFormData['reminder-time'];
                const streakTitle = tempFormData['streak-title'];
                
                addHabit(name, identity, reward, reminderTime, streakTitle);

                currentStep = 0;
                tempFormData = {};
                toggleNewHabitForm(false);
                return;
            } else {
                currentStep++;
                renderStep(currentStep);
            }
        };

        const handlePrevious = () => {
            if (currentStep > 0) {
                currentStep--;
                renderStep(currentStep);
            }
        };

        const toggleNewHabitForm = (force) => {
            const formContainer = document.getElementById('new-habit-form-container');
            const button = document.getElementById('toggle-form-btn');
            
            const isHidden = formContainer.classList.contains('max-h-0');
            let newState = force !== undefined ? force : isHidden;

            if (newState) {
                formContainer.classList.remove('max-h-0', 'invisible', 'opacity-0');
                formContainer.classList.add('max-h-96', 'opacity-100');
                button.textContent = 'å–æ¶ˆå»ºç«‹';
                button.classList.remove('bg-green-600');
                button.classList.add('bg-gray-600');
                
                currentStep = 0;
                tempFormData = {};
                renderStep(currentStep);
            } else {
                formContainer.classList.remove('max-h-96', 'opacity-100');
                formContainer.classList.add('max-h-0', 'invisible', 'opacity-0');
                button.textContent = 'â• å»ºç«‹æ–°ç¿’æ…£';
                button.classList.remove('bg-gray-600');
                button.classList.add('bg-green-600');
            }
        };
        
        async function handleAuthAction() {
            const currentUser = auth.currentUser;
            const feedbackElement = document.getElementById('feedback');
            const authButton = document.getElementById('auth-button');

            authButton.disabled = true; 
            feedbackElement.textContent = "è™•ç†ä¸­...";

            try {
                // å¦‚æœæ²’æœ‰ç™»å…¥ä»»ä½•å¸³æˆ¶ï¼Œæˆ–è€…ç•¶å‰æ˜¯åŒ¿åç™»å…¥ï¼Œéƒ½åŸ·è¡Œ Google ç™»å…¥ã€‚
                // signInWithPopup åœ¨åŒ¿åç™»å…¥çš„æƒ…æ³ä¸‹æœƒè‡ªå‹•å˜—è©¦é€£çµã€‚
                if (!currentUser || currentUser.isAnonymous) { 
                    await signInWithPopup(auth, googleProvider);
                    feedbackElement.textContent = "âœ… Google ç™»å…¥æˆåŠŸï¼";
                } else { // å¦‚æœå·²ç¶“æ˜¯æ°¸ä¹…å¸³æˆ¶ï¼Œå‰‡åŸ·è¡Œç™»å‡ºã€‚
                    await signOut(auth);
                    feedbackElement.textContent = "âœ… å·²ç™»å‡ºã€‚";
                }
            } catch (error) {
                console.error("èªè­‰æ“ä½œå¤±æ•—:", error);
                feedbackElement.textContent = `âš ï¸ æ“ä½œå¤±æ•—: ${error.message}`;
                if (error.code === 'auth/credential-already-in-use') {
                    feedbackElement.textContent = "æ­¤ Google å¸³æˆ¶å·²è¢«å…¶ä»– Firebase å¸³æˆ¶ä½¿ç”¨ã€‚";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    feedbackElement.textContent = "ç™»å…¥è¦–çª—å·²é—œé–‰ã€‚";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    // é€™æ˜¯ç•¶å˜—è©¦é€£çµä½†è©²Googleå¸³æˆ¶å·²é€£çµåˆ°å¦ä¸€å€‹éåŒ¿åå¸³æˆ¶æ™‚å¯èƒ½ç™¼ç”Ÿ
                    feedbackElement.textContent = "é€™å€‹ Google å¸³æˆ¶å·²ç¶“é€£çµåˆ°å…¶ä»–å¸³æˆ¶ã€‚";
                }
            } finally {
                authButton.disabled = false; 
                setTimeout(() => feedbackElement.textContent = '', 5000); 
            }
        }

        function renderAuthUI(user) {
            const authContainer = document.getElementById('auth-ui-container');
            if (!authContainer) { 
                console.warn("auth-ui-container not found in DOM.");
                return;
            } 

            authContainer.innerHTML = ''; 

            if (!user || user.isAnonymous) { // æ²’æœ‰ä½¿ç”¨è€…ï¼Œæˆ–ç‚ºåŒ¿åä½¿ç”¨è€…ï¼Œéƒ½é¡¯ç¤ºã€Œç™»å…¥ã€
                authContainer.innerHTML = `
                    <button id="auth-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 shadow-md text-sm">
                        ç™»å…¥
                    </button>
                `;
            } else { // å·²ç™»å…¥æ°¸ä¹…å¸³æˆ¶ (ä¾‹å¦‚ Google)
                const displayName = user.displayName || user.email || 'ä½¿ç”¨è€…';
                authContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-300 hidden sm:block">å“ˆå›‰, ${displayName}</span>
                        <button id="auth-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 shadow-md text-sm">
                            ç™»å‡º
                        </button>
                    </div>
                `;
            }
            document.getElementById('auth-button')?.addEventListener('click', handleAuthAction);
        }

        const initFirebaseAndApp = () => {
            if (!Object.keys(firebaseConfig).length || !firebaseConfig.apiKey) {
                console.error("Firebase é…ç½®éºå¤±ã€‚ç„¡æ³•åˆå§‹åŒ– Firebaseã€‚");
                document.getElementById('app-status').textContent = "âš ï¸ éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚";
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app); 
                messaging = getMessaging(app); 

                document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: åˆå§‹åŒ–ä¸­...";
                
                const authenticate = async () => {
                    try {
                        if (initialAuthToken) { 
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else { 
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("èªè­‰å¤±æ•—:", error);
                        document.getElementById('app-status').textContent = `âŒ èªè­‰å¤±æ•—: ${error.code}`;
                        try {
                             await signInAnonymously(auth); 
                        } catch(anonError) {
                            console.error("åŒ¿åç™»å…¥ä¹Ÿå¤±æ•—äº†:", anonError);
                        }
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: é€£ç·šæˆåŠŸ";
                        document.getElementById('user-id-display').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
                        loadHabits(); 
                    } else {
                        if (userId === null) { 
                            document.getElementById('app-status').textContent = "æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹: ç™»å…¥ä¸­...";
                            authenticate(); 
                        }
                    }
                    renderAuthUI(user); 
                });
                
                authenticate();

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                document.getElementById('app-status').textContent = `âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`;
            }

        };

        window.onload = () => {
            setupPWA(); 
            initFirebaseAndApp();
            
            document.getElementById('new-habit-form').addEventListener('submit', (e) => e.preventDefault()); 
            document.getElementById('toggle-form-btn').addEventListener('click', () => toggleNewHabitForm());
            
            document.getElementById('next-btn').addEventListener('click', handleNext);
            document.getElementById('prev-btn').addEventListener('click', handlePrevious);
            
            renderStep(currentStep); 
        };

    </script>
</body>
</html>
