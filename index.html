<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸå­RPGï¼šå…¨å‰¯æ­¦è£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Press+Start+2P&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .font-pixel { font-family: 'Press Start 2P', cursive; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-content { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.5s; }
        
        /* è£å‚™ç¨€æœ‰åº¦å…‰èŠ’ */
        .rarity-common { border-color: #94a3b8; box-shadow: 0 0 5px rgba(148, 163, 184, 0.3); }
        .rarity-rare { border-color: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.4); }
        .rarity-epic { border-color: #a855f7; box-shadow: 0 0 12px rgba(168, 85, 247, 0.5); }
        .rarity-legendary { border-color: #eab308; box-shadow: 0 0 15px rgba(234, 179, 8, 0.6); }

        /* è£å‚™æ¬„ä½æ¨£å¼ */
        .equip-slot {
            background-color: #1e293b;
            border: 2px dashed #475569;
            transition: all 0.3s;
        }
        .equip-slot.filled {
            border-style: solid;
            background-color: #1e293b;
        }
    </style>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body class="min-h-screen p-2 sm:p-4 pb-24 relative overflow-x-hidden">
    
    <div id="encounter-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="modal-content bg-gray-800 border-2 border-red-500 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl relative text-center">
            <h3 class="text-red-500 font-bold tracking-widest text-sm uppercase mb-4 animate-pulse">âš ï¸ WARNING</h3>
            <div class="relative w-24 h-24 mx-auto bg-gray-900 rounded-full border-4 border-gray-700 flex items-center justify-center mb-4">
                <img id="encounter-img" src="" class="w-20 h-20 object-contain rendering-pixelated">
            </div>
            <h2 id="encounter-name" class="text-xl font-extrabold text-white mb-1"></h2>
            <p id="encounter-desc" class="text-gray-400 text-xs italic mb-4"></p>
            <div class="bg-gray-900/80 p-3 rounded-lg border border-red-500/30 mb-6">
                <p class="text-xs text-red-400 uppercase font-bold">æŒ‘æˆ°ç›®æ¨™</p>
                <p id="encounter-target" class="text-lg font-bold text-white mt-1"></p>
            </div>
            <button id="accept-battle-btn" class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white font-bold py-3 rounded-xl shadow-lg">
                ğŸ‘Š æ¥å—æŒ‘æˆ°
            </button>
        </div>
    </div>

    <div id="loot-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300">
        <div class="modal-content bg-gray-800 border-2 border-yellow-500 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-[0_0_50px_rgba(234,179,8,0.2)] text-center relative">
            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-4xl">ğŸ‰</div>
            <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">æˆ°é¬¥å‹åˆ©ï¼</h2>
            <div id="loot-container" class="hidden mb-6 mt-4">
                <p class="text-xs text-yellow-200 uppercase font-bold mb-2">ç²å¾—è£å‚™</p>
                <div class="bg-gray-900 p-3 rounded-xl border-2 flex items-center gap-4 text-left" id="loot-card">
                    <div class="text-3xl" id="loot-icon"></div>
                    <div>
                        <p class="font-bold text-white text-sm" id="loot-name"></p>
                        <p class="text-xs text-gray-400" id="loot-rarity"></p>
                    </div>
                </div>
            </div>
            <button id="claim-loot-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition">æ”¶ä¸‹çå‹µ</button>
        </div>
    </div>

    <div id="inventory-modal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/80 hidden">
        <div class="bg-gray-800 w-full max-w-md h-[80vh] rounded-t-2xl sm:rounded-2xl p-4 flex flex-col border border-gray-700 relative">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h2 class="text-xl font-bold text-white">ğŸ’ èƒŒåŒ…</h2>
                <button onclick="document.getElementById('inventory-modal').classList.add('hidden')" class="text-gray-400 text-2xl">&times;</button>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2 pr-1">
                </div>
        </div>
    </div>

    <div class="max-w-xl mx-auto">
        <header class="mb-4 pt-4 flex justify-between items-end px-2"> 
            <div>
                <h1 class="text-2xl font-extrabold text-white">è§’è‰²é¢æ¿</h1>
                <p class="text-indigo-400 text-xs">è£å‚™ä½ çš„ç¿’æ…£æˆ°åˆ©å“</p>
            </div>
            <div class="flex gap-2">
                <button id="open-inventory-btn" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg shadow text-xl relative">
                    ğŸ’ <span id="inventory-count" class="absolute -top-1 -right-1 bg-red-500 text-[10px] w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
                </button>
                <div id="auth-ui-container"></div>
            </div>
        </header>

        <div class="mb-6 bg-gray-900/50 p-2 rounded-xl shadow-lg border border-gray-700">
            <div class="grid grid-cols-[1fr_2fr_1fr] gap-1 sm:gap-2 items-center">
                
                <div class="flex flex-col gap-2">
                    <div id="slot-head" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">ğŸ§¢</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">é ­éƒ¨</span>
                    </div>
                    <div id="slot-body" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">ğŸ‘•</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">è»€å¹¹</span>
                    </div>
                    <div id="slot-legs" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">ğŸ‘–</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">è…¿éƒ¨</span>
                    </div>
                </div>

                <div class="relative h-48 w-full flex items-center justify-center">
                    <canvas id="attributeRadarChart"></canvas>
                </div>

                <div class="flex flex-col gap-2">
                    <div id="slot-weapon" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">âš”ï¸</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">æ­¦å™¨</span>
                    </div>
                    <div id="slot-necklace" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">ğŸ“¿</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">é …éŠ</span>
                    </div>
                    <div id="slot-shoes" class="equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group">
                        <span class="text-xl opacity-30">ğŸ‘Ÿ</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">é‹å­</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-6 px-2">
            <button id="toggle-form-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg flex justify-center items-center gap-2">
                <span>â•</span> <span>å»ºç«‹ä¿®ç·´é …ç›®</span>
            </button>
            <div id="new-habit-form-container" class="mt-4 overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0 invisible">
                <form id="new-habit-form" class="bg-gray-700 p-4 rounded-xl shadow-inner space-y-4">
                    <div id="step-content"></div>
                    <div class="pt-2 flex justify-end">
                        <button type="button" id="next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full">ä¸‹ä¸€æ­¥</button>
                    </div>
                </form>
            </div>
        </div>

        <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2 px-2">ç•¶å‰ä¿®ç·´</h2>
        <div id="habit-list" class="space-y-4 px-2"></div>
        <div id="no-habits" class="hidden text-center text-gray-500 mt-8">æš«ç„¡ä¿®ç·´ï¼Œå¿«å»å»ºç«‹ä¸€å€‹å§ï¼</div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur-sm p-2 border-t border-indigo-900/50 z-50 text-center">
        <p id="feedback" class="h-5 text-sm font-bold text-yellow-400 mb-1"></p>
        <p id="app-status" class="text-[10px] text-gray-600">System Online</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"; 
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAa2PYFB90eMMXF4jlZRgvpqZr3Eof916U",
            authDomain: "habitkeeper-87e88.firebaseapp.com",
            projectId: "habitkeeper-87e88",
            storageBucket: "habitkeeper-87e88.firebasestorage.app",
            messagingSenderId: "773693972402",
            appId: "1:773693972402:web:23ae51483f3e1a4926ceab"
        };

        const appId = firebaseConfig.appId; 
        let app, db, auth, userId;
        let radarChartInstance = null;
        let activeBattles = {}; 
        let userInventory = [];
        let equippedItems = { head: null, body: null, legs: null, weapon: null, necklace: null, shoes: null };

        // --- Game Data: Monster & Loot ---
        // æ›´æ–°å¾Œçš„ Loot Tableï¼ŒåŒ…å«å…·é«”çš„ slot (éƒ¨ä½)
        const LOOT_TABLE = [
            { name: "æœ¨åŠ", icon: "ğŸ—¡ï¸", slot: "weapon", rarity: 1 },
            { name: "æ–°æ‰‹é ­å¸¶", icon: "ğŸ¤•", slot: "head", rarity: 1 },
            { name: "å¸ƒè¡£", icon: "ğŸ‘•", slot: "body", rarity: 1 },
            { name: "è‰é‹", icon: "ğŸ‘¡", slot: "shoes", rarity: 1 },
            
            { name: "ç”Ÿé½éµåŠ", icon: "ğŸ—¡ï¸", slot: "weapon", rarity: 2 },
            { name: "çš®å¸½", icon: "ğŸ§¢", slot: "head", rarity: 2 },
            { name: "çš®ç”²", icon: "ğŸ¦º", slot: "body", rarity: 2 },
            { name: "çµäººé•·è¤²", icon: "ğŸ‘–", slot: "legs", rarity: 2 },
            { name: "çš®é´", icon: "ğŸ‘¢", slot: "shoes", rarity: 2 },
            { name: "å¹¸é‹ç¬¦", icon: "ğŸ§¿", slot: "necklace", rarity: 2 },

            { name: "å‹‡è€…ä¹‹åŠ", icon: "âš”ï¸", slot: "weapon", rarity: 3 },
            { name: "é¨å£«é ­ç›”", icon: "â›‘ï¸", slot: "head", rarity: 3 },
            { name: "æ¿ç”²", icon: "ğŸ›¡ï¸", slot: "body", rarity: 3 },
            { name: "é‡ç”²è­·è…¿", icon: "ğŸ¦µ", slot: "legs", rarity: 3 },
            { name: "ç´…å¯¶çŸ³é …éŠ", icon: "ğŸ“¿", slot: "necklace", rarity: 3 },

            { name: "Excalibur", icon: "âœ¨", slot: "weapon", rarity: 4 },
            { name: "é¾é±—é§ç”²", icon: "ğŸ‰", slot: "body", rarity: 4 }
        ];

        const MONSTERS = [
            { id: 'm1', minStreak: 0, chance: 40, name: "æœå‡å²èŠå§†", seed: "slime", desc: "è»ŸQå°æ‰‹", multiplier: 1.0 },
            { id: 'm2', minStreak: 0, chance: 30, name: "å¹²æ“¾è™è ", seed: "bat", desc: "åˆ†å¿ƒæ”»æ“Š", multiplier: 1.0 },
            { id: 'm3', minStreak: 3, chance: 40, name: "å“¥å¸ƒæ—", seed: "goblin", desc: "å……æ»¿èª˜æƒ‘", multiplier: 1.1 },
            { id: 'm4', minStreak: 7, chance: 30, name: "éª·é«å…µ", seed: "skeleton", desc: "å …æŒå°±æ˜¯å‹åˆ©", multiplier: 1.2 },
            { id: 'm5', minStreak: 14, chance: 20, name: "é‡ç”²å®ˆè¡›", seed: "guard", desc: "å¼·æ•µå‡ºç¾", multiplier: 1.5 },
            { id: 'm6', minStreak: 21, chance: 10, name: "å¿ƒé­”å·¨é¾", seed: "dragon", desc: "æ¥µé™æŒ‘æˆ°", multiplier: 2.0 }
        ];

        const ATTRIBUTES = {
            'STR': { label: 'åŠ›é‡', color: '#ef4444' }, 'AGI': { label: 'æ•æ·', color: '#3b82f6' },
            'SPI': { label: 'ç²¾ç¥', color: '#a855f7' }, 'INT': { label: 'æ™ºåŠ›', color: '#10b981' },
            'LUK': { label: 'é‹æ°£', color: '#eab308' }
        };

        const rarityColors = ["", "text-gray-400", "text-blue-400", "text-purple-400", "text-yellow-400"];
        const rarityBorders = ["", "rarity-common", "rarity-rare", "rarity-epic", "rarity-legendary"];

        // --- Core Functions ---

        const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        const calculateStreak = (history) => {
            if (!history || history.length === 0) return { streak: 0, completedToday: false };
            const todayStr = formatDate(new Date());
            const isCompletedToday = history.includes(todayStr);
            let currentStreak = 0;
            let d = new Date();
            if (isCompletedToday) { currentStreak = 1; d.setDate(d.getDate() - 1); }
            else { return { streak: 0, completedToday: false }; }
            for (let i = 0; i < 365; i++) {
                if (history.includes(formatDate(d))) { currentStreak++; d.setDate(d.getDate() - 1); } else break;
            }
            return { streak: currentStreak, completedToday: true };
        };

        // --- Battle & Loot Logic ---

        const triggerEncounter = (habitId, habitData) => {
            const { streak } = calculateStreak(habitData.history);
            const eligible = MONSTERS.filter(m => streak >= m.minStreak);
            const monster = eligible[Math.floor(Math.random() * eligible.length)] || MONSTERS[0];
            
            const modal = document.getElementById('encounter-modal');
            document.getElementById('encounter-img').src = `https://api.dicebear.com/9.x/pixel-art/svg?seed=${monster.seed}`;
            document.getElementById('encounter-name').textContent = monster.name;
            document.getElementById('encounter-desc').textContent = monster.desc;
            
            let targetText = habitData.minimumAction;
            if (monster.multiplier > 1) {
                targetText += ` (å¼·åº¦ x${Math.floor(monster.multiplier * 100)}%)`;
                document.getElementById('encounter-target').classList.add('text-yellow-400');
            } else {
                document.getElementById('encounter-target').classList.remove('text-yellow-400');
            }
            document.getElementById('encounter-target').textContent = targetText;

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            document.getElementById('accept-battle-btn').onclick = () => {
                activeBattles[habitId] = monster;
                renderHabits(window.cachedHabits); // Update UI state
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };
        };

        const resolveBattle = async (habitId, success) => {
            if (!success) {
                if(confirm("æ”¾æ£„ä¿®ç·´ï¼Ÿ")) { delete activeBattles[habitId]; renderHabits(window.cachedHabits); }
                return;
            }

            const monster = activeBattles[habitId];
            const habitData = window.cachedHabits.find(h => h.id === habitId);
            const todayStr = formatDate(new Date());

            // 1. Update History
            if (!habitData.history.includes(todayStr)) {
                const newHistory = [...habitData.history, todayStr].sort();
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, habitId), { history: newHistory });
            }

            // 2. Loot Calculation
            let lootItem = null;
            const dropChance = 0.4 + (monster.multiplier - 1) * 0.4; // ç¨å¾®èª¿é«˜æ©Ÿç‡
            if (Math.random() < dropChance) {
                const roll = Math.random() * monster.multiplier; 
                let rarityTier = 1;
                if (roll > 1.8) rarityTier = 4;
                else if (roll > 1.4) rarityTier = 3;
                else if (roll > 1.1) rarityTier = 2;

                const possibleLoot = LOOT_TABLE.filter(i => i.rarity === rarityTier || i.rarity === rarityTier - 1);
                if (possibleLoot.length > 0) lootItem = possibleLoot[Math.floor(Math.random() * possibleLoot.length)];
            }

            if (lootItem) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/inventory`), { ...lootItem, obtainedAt: new Date() });
            }

            // Show Result
            const modal = document.getElementById('loot-modal');
            const lootContainer = document.getElementById('loot-container');
            if (lootItem) {
                lootContainer.classList.remove('hidden');
                document.getElementById('loot-icon').textContent = lootItem.icon;
                document.getElementById('loot-name').textContent = lootItem.name;
                document.getElementById('loot-rarity').textContent = ["","æ™®é€š","ç¨€æœ‰","å²è©©","å‚³èªª"][lootItem.rarity];
                document.getElementById('loot-card').className = `bg-gray-900 p-3 rounded-xl border-2 flex items-center gap-4 text-left ${rarityBorders[lootItem.rarity]}`;
            } else {
                lootContainer.classList.add('hidden');
            }
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            
            document.getElementById('claim-loot-btn').onclick = () => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            delete activeBattles[habitId];
        };

        // --- Equipment System ---

        const loadEquipment = () => {
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/playerData`, 'equipment'), (docSnap) => {
                if (docSnap.exists()) {
                    equippedItems = docSnap.data();
                }
                renderEquipmentSlots();
            });
        };

        const renderEquipmentSlots = () => {
            const slots = ['head', 'body', 'legs', 'weapon', 'necklace', 'shoes'];
            const labels = { head: 'é ­éƒ¨', body: 'è»€å¹¹', legs: 'è…¿éƒ¨', weapon: 'æ­¦å™¨', necklace: 'é …éŠ', shoes: 'é‹å­' };
            const defaultIcons = { head: 'ğŸ§¢', body: 'ğŸ‘•', legs: 'ğŸ‘–', weapon: 'âš”ï¸', necklace: 'ğŸ“¿', shoes: 'ğŸ‘Ÿ' };

            slots.forEach(slotKey => {
                const el = document.getElementById(`slot-${slotKey}`);
                const item = equippedItems[slotKey];
                
                if (item) {
                    el.className = `equip-slot filled w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group ${rarityBorders[item.rarity]}`;
                    el.innerHTML = `
                        <span class="text-2xl drop-shadow-md">${item.icon}</span>
                        <div class="absolute inset-0 bg-black/80 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-lg text-xs text-white font-bold p-1 text-center">
                            ${item.name}
                        </div>
                    `;
                    el.onclick = () => { if(confirm(`å¸ä¸‹ ${item.name}?`)) equipItem(slotKey, null); };
                } else {
                    el.className = `equip-slot w-full aspect-square rounded-lg flex flex-col items-center justify-center cursor-pointer relative group opacity-50 hover:opacity-100`;
                    el.innerHTML = `
                        <span class="text-xl opacity-30">${defaultIcons[slotKey]}</span>
                        <span class="text-[8px] text-gray-500 absolute bottom-0.5">${labels[slotKey]}</span>
                    `;
                    el.onclick = () => { 
                        document.getElementById('inventory-modal').classList.remove('hidden'); 
                        // é€™è£¡å¯ä»¥åšéæ¿¾ï¼Œåªé¡¯ç¤ºè©²éƒ¨ä½è£å‚™ï¼Œæš«æ™‚é¡¯ç¤ºå…¨éƒ¨
                    };
                }
            });
        };

        const equipItem = async (slot, itemData) => {
            const newEquipment = { ...equippedItems };
            if (itemData) {
                newEquipment[slot] = itemData;
                document.getElementById('feedback').textContent = `å·²è£å‚™: ${itemData.name}`;
            } else {
                delete newEquipment[slot];
            }
            
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/playerData`, 'equipment'), newEquipment);
            setTimeout(() => document.getElementById('feedback').textContent = '', 2000);
        };

        // --- Inventory & UI ---

        const loadInventory = () => {
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/inventory`), (snap) => {
                userInventory = [];
                snap.forEach(d => userInventory.push({ id: d.id, ...d.data() }));
                
                const countSpan = document.getElementById('inventory-count');
                countSpan.textContent = userInventory.length;
                countSpan.classList.toggle('hidden', userInventory.length === 0);

                const list = document.getElementById('inventory-list');
                list.innerHTML = userInventory.map(item => {
                    const slotName = { head: 'é ­éƒ¨', body: 'è»€å¹¹', legs: 'è…¿éƒ¨', weapon: 'æ­¦å™¨', necklace: 'é …éŠ', shoes: 'é‹å­' }[item.slot] || 'æœªçŸ¥';
                    const isEquipped = Object.values(equippedItems).some(e => e && e.name === item.name); // ç°¡å–®æ¯”å°ï¼Œå¯¦éš›æ‡‰æ¯”å°ID
                    
                    return `
                        <div class="bg-gray-700/50 p-3 rounded-lg flex items-center justify-between border border-gray-600 mb-2">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">${item.icon}</div>
                                <div>
                                    <p class="text-white font-bold text-sm">${item.name}</p>
                                    <p class="text-[10px] ${rarityColors[item.rarity]}">${slotName} â€¢ ${["","æ™®é€š","ç¨€æœ‰","å²è©©","å‚³èªª"][item.rarity]}</p>
                                </div>
                            </div>
                            <button onclick="window.dispatchEvent(new CustomEvent('equip-request', {detail: '${item.id}'}))" 
                                class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-full transition">
                                è£å‚™
                            </button>
                        </div>
                    `;
                }).join('');
            });
        };

        window.addEventListener('equip-request', (e) => {
            const item = userInventory.find(i => i.id === e.detail);
            if (item && item.slot) {
                equipItem(item.slot, item);
                document.getElementById('inventory-modal').classList.add('hidden');
            } else {
                alert('æ­¤ç‰©å“ç„¡æ³•è£å‚™ï¼');
            }
        });

        // --- Standard Habit Functions (Render, Add, etc.) ---

        const renderHabits = (habits) => {
            window.cachedHabits = habits;
            const habitList = document.getElementById('habit-list');
            const noHabits = document.getElementById('no-habits');
            habitList.innerHTML = ''; 
            noHabits.classList.toggle('hidden', habits.length > 0);

            habits.forEach(habit => {
                const { streak, completedToday } = calculateStreak(habit.history);
                const inBattle = activeBattles[habit.id];
                const attrColor = ATTRIBUTES[habit.attribute || 'LUK'].color;
                
                let actionHtml = '';
                let borderClass = `border-l-4`;
                let borderColor = attrColor;

                if (completedToday) {
                    actionHtml = `<button disabled class="w-full bg-green-900/30 text-green-400 font-bold py-2 rounded-lg text-sm cursor-not-allowed">âœ… å®Œæˆ</button>`;
                    borderColor = '#10b981';
                } else if (inBattle) {
                    borderColor = '#ef4444';
                    actionHtml = `
                        <div class="bg-gray-900/80 p-2 rounded border border-red-500/50 mb-2 flex items-center gap-2">
                             <img src="https://api.dicebear.com/9.x/pixel-art/svg?seed=${inBattle.seed}" class="w-8 h-8 shake">
                             <div class="flex-1">
                                <p class="text-red-400 text-xs font-bold">vs ${inBattle.name}</p>
                                <p class="text-[10px] text-gray-400">å¼·åº¦: ${Math.floor(inBattle.multiplier*100)}%</p>
                             </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.dispatchEvent(new CustomEvent('resolve-battle', {detail: {id: '${habit.id}', win: false}}))" class="flex-1 bg-gray-700 text-xs py-2 rounded">æ’¤é€€</button>
                            <button onclick="window.dispatchEvent(new CustomEvent('resolve-battle', {detail: {id: '${habit.id}', win: true}}))" class="flex-1 bg-green-600 text-white text-xs py-2 rounded font-bold shadow-lg animate-pulse">å‹åˆ©!</button>
                        </div>
                    `;
                } else {
                    actionHtml = `<button onclick="window.dispatchEvent(new CustomEvent('trigger-encounter', {detail: '${habit.id}'}))" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg text-sm shadow">ä¿®ç·´</button>`;
                }

                const card = `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4 relative overflow-hidden ${borderClass}" style="border-color:${borderColor}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-white">${habit.goal}</h3>
                            <div class="text-right">
                                <span class="text-xl font-bold ${streak>0?'text-green-400':'text-gray-500'}">${streak}</span>
                                <span class="text-[10px] text-gray-500 block">DAYS</span>
                            </div>
                        </div>
                        <p class="text-gray-400 text-xs mb-3 pl-2 border-l-2 border-gray-600">${habit.minimumAction}</p>
                        ${actionHtml}
                        ${(!inBattle && !completedToday) ? `<button onclick="window.dispatchEvent(new CustomEvent('remove-habit', {detail: '${habit.id}'}))" class="absolute top-2 right-2 text-gray-600 hover:text-red-400 text-xs">âœ•</button>` : ''}
                    </div>
                `;
                habitList.insertAdjacentHTML('beforeend', card);
            });
            updateRadarChart(habits);
        };

        window.addEventListener('trigger-encounter', e => triggerEncounter(e.detail, window.cachedHabits.find(h=>h.id===e.detail)));
        window.addEventListener('resolve-battle', e => resolveBattle(e.detail.id, e.detail.win));
        window.addEventListener('remove-habit', async e => { if(confirm("ç§»é™¤?")) await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/habits`, e.detail)); });

        // Chart Update
        const updateRadarChart = (habits) => {
            const ctx = document.getElementById('attributeRadarChart').getContext('2d');
            const stats = { 'STR': 1, 'AGI': 1, 'SPI': 1, 'INT': 1, 'LUK': 1 };
            habits.forEach(h => { if(stats[h.attribute]) stats[h.attribute] += (h.history?.length || 0); });
            // é€™è£¡æœªä¾†å¯ä»¥åŠ å…¥è£å‚™åŠ æˆé‚è¼¯ (Bonus Stats)
            
            const data = Object.values(stats);
            const maxVal = Math.max(...data, 10);

            if (radarChartInstance) {
                radarChartInstance.data.datasets[0].data = data;
                radarChartInstance.options.scales.r.max = maxVal + 5;
                radarChartInstance.update();
            } else {
                radarChartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: Object.values(ATTRIBUTES).map(a => a.label),
                        datasets: [{
                            label: 'Stats',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: '#818cf8',
                            pointBackgroundColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { r: { ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#cbd5e1', font: {size: 10} }, min: 0, max: maxVal + 5 } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        };

        // Form Logic (Simplified for brevity but functional)
        let tempFormData = {};
        let currentStep = 0;
        const STEPS = [
            { id: 'habit-goal', label: 'ä¿®ç·´ç›®æ¨™', type: 'text' },
            { id: 'habit-attribute', label: 'èƒ½åŠ›', type: 'select', options: Object.keys(ATTRIBUTES).map(k => ({val: k, txt: ATTRIBUTES[k].label})) },
            { id: 'minimum-action', label: 'æœ€å°è¡Œå‹•', type: 'text' }
        ];

        const renderStep = () => {
            const step = STEPS[currentStep];
            const content = document.getElementById('step-content');
            let inputHtml = step.type === 'select' 
                ? `<select id="${step.id}" class="w-full p-2 bg-gray-600 rounded text-white">${step.options.map(o=>`<option value="${o.val}">${o.txt}</option>`).join('')}</select>`
                : `<input id="${step.id}" class="w-full p-2 bg-gray-600 rounded text-white placeholder-gray-400" placeholder="${step.label}...">`;
            content.innerHTML = `<label class="text-gray-300 text-sm block mb-1">${step.label}</label>${inputHtml}`;
            document.getElementById('next-btn').textContent = currentStep === STEPS.length - 1 ? 'å®Œæˆ' : 'ä¸‹ä¸€æ­¥';
        };

        document.getElementById('toggle-form-btn').onclick = () => {
            const c = document.getElementById('new-habit-form-container');
            const show = c.classList.contains('max-h-0');
            c.classList.toggle('max-h-0'); c.classList.toggle('opacity-0'); c.classList.toggle('invisible');
            if(show) { currentStep = 0; renderStep(); }
        };

        document.getElementById('next-btn').onclick = async () => {
            const val = document.getElementById(STEPS[currentStep].id).value;
            tempFormData[STEPS[currentStep].id] = val;
            if(currentStep < STEPS.length - 1) { currentStep++; renderStep(); }
            else {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/habits`), {
                    goal: tempFormData['habit-goal'], attribute: tempFormData['habit-attribute'],
                    minimumAction: tempFormData['minimum-action'], history: [], createdAt: new Date()
                });
                document.getElementById('toggle-form-btn').click();
            }
        };
        
        document.getElementById('open-inventory-btn').onclick = () => document.getElementById('inventory-modal').classList.remove('hidden');

        // Init
        window.onload = () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, u => {
                if(u) { 
                    userId = u.uid; 
                    onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/habits`), s => {
                        const h = []; s.forEach(d => h.push({id: d.id, ...d.data()}));
                        renderHabits(h);
                    });
                    loadInventory();
                    loadEquipment(); // è¼‰å…¥è£å‚™
                    document.getElementById('auth-ui-container').innerHTML = `<button onclick="location.reload()" class="text-[10px] text-gray-500">REFRESH</button>`;
                } else signInAnonymously(auth);
            });
        };
    </script>
</body>
</html>
